# Certificate Setup

In order to generate certificates, they must be generated by an elasticsearch instance. To achieve this, we temporarily spin up an elasticsearch container on OCP in order to generate and extract the certificates. This is then pushed up as secrets.

## Steps

Login to namespace
Spin up a temporary instance of the elasticsearch version you want (7.5.1).

``` bash
export ELK_VERSION=7.5.1

oc run cert --image=elastic/elasticsearch:$ELK_VERSION --command -it --rm --restart=Never -- bash
```

Open new terminal, login to same namespace.
Create certs for desired elasticsearch host (`${APP_NAME}-${INSTANCE}`).

``` bash
export APP_NAME=elasticsearch
export INSTANCE=jujaga

export ELASTIC_NAME=elasticsearch
export KIBANA_NAME=kibana

oc rsh cert elasticsearch-certutil ca --out /tmp/$APP_NAME-ca.p12 --pass ''
oc rsh cert elasticsearch-certutil cert --name $APP_NAME --dns $APP_NAME-$INSTANCE --ca /tmp/$APP_NAME-ca.p12 --pass '' --ca-pass '' --out /tmp/$APP_NAME-certificates.p12
oc cp cert:/tmp/$APP_NAME-ca.p12 ./
oc cp cert:/tmp/$APP_NAME-certificates.p12 ./
openssl pkcs12 -nodes -passin pass:'' -in $APP_NAME-certificates.p12 -out $APP_NAME-certificate.pem
openssl pkcs12 -clcerts -nokeys -passin pass:'' -in $APP_NAME-ca.p12 -out $APP_NAME-ca.pem
```

### Create secrets

``` bash
oc create secret generic $APP_NAME-$INSTANCE-certificates --from-file=$APP_NAME-certificates.p12
oc create secret generic $APP_NAME-$INSTANCE-certificate-pem --from-file=$APP_NAME-certificate.pem
oc create secret generic $APP_NAME-$INSTANCE-ca-pem --from-file=$APP_NAME-ca.pem


oc process -f elasticstack.secret.yaml -p ELASTIC_NAME=$ELASTIC_NAME -p KIBANA_NAME=$KIBANA_NAME -p INSTANCE=$INSTANCE | oc create -f -
```

### Delete cert pod

``` bash
oc delete pod/cert --force
```

# Elastic Stack on Openshift

This readme outlines how to setup and configure an Openshift project to get the Elastic Stack to a deployable state. This document assumes a working knowledge of Kubernetes/Openshift container orchestration concepts (i.e. buildconfigs, deployconfigs, imagestreams, secrets, configmaps, routes, etc)

Our builds and deployments can be orchestrated with Jenkins. However at this time, all manifests are to be manually invoked.

## Environment Setup - ConfigMaps and Secrets

There are some requirements in the target Openshift namespace/project which are **outside** of the CI/CD pipeline process. This application requires that a few Secrets as well as Config Maps be already present in the environment before it is able to function as intended. Otherwise the deployments fail due to missing data.

In order to prepare an environment, you will need to ensure that all of the following configmaps and secrets are populated. This is achieved by executing the following commands as a project administrator of the targeted environment. Note that this must be repeated on *each* of the target deployment namespace/projects (i.e. `dev`, `test` and `prod`) as that they are independent of each other. Deployment will fail otherwise.

### Config Maps

At this time, all config maps are defined in the deploymentconfig manifest templates. As the Elastic Stack components are mainly configured through yaml files, the majority of the config maps will end up being mounted onto the containers at specific directory locations. Refer to the [Official Elastic Stack documentation](https://www.elastic.co/guide/index.html) for more details on how to manage your Elastic Stack components.

### Secrets

Elastic Stack secrets involves the use of a combination of TLS Certificates and user/password secrets. In order to generate Elastic Stack compatible certificates, they must be generated by an elasticsearch instance. To achieve this, we temporarily spin up an elasticsearch container on OCP in order to generate and extract the certificates. This is then pushed up as secrets.

#### Certificate Generation

Ensure your OpenShift CLI tool is logged in. Make sure you change your namespace to the correct project with `oc project <projectname>`.

##### Start Temporary Elasticsearch Pod

``` bash
export ELK_VERSION=7.5.1

oc run cert --image=elastic/elasticsearch:$ELK_VERSION --command -it --rm --restart=Never -- bash
```

##### Generate Certificates

Open a new terminal and ensure your OpenShift CLI tool is logged in. Make sure you change your namespace to the correct project with `oc project <projectname>`. You will create certs for desired elasticsearch host (`${APP_NAME}-${INSTANCE}`).

``` bash
export APP_NAME=elasticsearch
export INSTANCE=master

oc rsh cert elasticsearch-certutil ca --out /tmp/$APP_NAME-ca.p12 --pass ''
oc rsh cert elasticsearch-certutil cert --name $APP_NAME --dns $APP_NAME-$INSTANCE --ca /tmp/$APP_NAME-ca.p12 --pass '' --ca-pass '' --out /tmp/$APP_NAME-certificates.p12
oc cp cert:/tmp/$APP_NAME-ca.p12 ./
oc cp cert:/tmp/$APP_NAME-certificates.p12 ./
openssl pkcs12 -nodes -passin pass:'' -in $APP_NAME-certificates.p12 -out $APP_NAME-certificate.pem
openssl pkcs12 -clcerts -nokeys -passin pass:'' -in $APP_NAME-ca.p12 -out $APP_NAME-ca.pem
```

#### Create Secrets

Once the four certificate files are created, we can add them to OpenShift secrets.

``` bash
oc create secret generic $APP_NAME-$INSTANCE-certificates --from-file=$APP_NAME-certificates.p12
oc create secret generic $APP_NAME-$INSTANCE-certificate-pem --from-file=$APP_NAME-certificate.pem
oc create secret generic $APP_NAME-$INSTANCE-ca-pem --from-file=$APP_NAME-ca.pem

oc process -f elasticstack.secret.yaml -p INSTANCE=$INSTANCE | oc create -f -
```

##### Stop & Remove Temporary Elasticsearch Pod

Once the secrets are up, you need to dispose of your cert pod. This can be done by exiting out of the remote terminal shell, or by force deleting the specific cert pod.

``` bash
oc delete pod/cert --force
```
